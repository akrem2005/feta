<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebRTC Video Chat</title>
    <style>
      body {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        background-color: #f0f0f0;
      }
      video {
        width: 300px;
        height: 200px;
        border: 1px solid black;
      }
      button {
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <video id="localVideo" autoplay muted></video>
      <video id="remoteVideo" autoplay></video>
      <button id="startButton">Start</button>
      <button id="callButton">Call</button>
      <button id="hangupButton">Hang Up</button>
    </div>
    <script>
      const localVideo = document.getElementById("localVideo");
      const remoteVideo = document.getElementById("remoteVideo");
      const startButton = document.getElementById("startButton");
      const callButton = document.getElementById("callButton");
      const hangupButton = document.getElementById("hangupButton");

      let localStream;
      let remoteStream;
      let peerConnection;
      let room;

      startButton.addEventListener("click", start);
      callButton.addEventListener("click", call);
      hangupButton.addEventListener("click", hangup);

      async function start() {
        const constraints = {
          video: true,
          audio: true,
        };
        localStream = await navigator.mediaDevices.getUserMedia(constraints);
        localVideo.srcObject = localStream;
      }

      function call() {
        callButton.disabled = true;
        hangupButton.disabled = false;

        const configuration = {
          iceServers: [
            {
              urls: "stun:stun.l.google.com:19302",
            },
          ],
        };

        peerConnection = new RTCPeerConnection(configuration);

        peerConnection.addEventListener("icecandidate", handleIceCandidate);
        peerConnection.addEventListener("track", handleRemoteStream);

        localStream.getTracks().forEach((track) => {
          peerConnection.addTrack(track, localStream);
        });

        room = "room1";

        peerConnection
          .createOffer()
          .then((offer) => {
            return peerConnection.setLocalDescription(offer);
          })
          .then(() => {
            socket.emit("join", {
              room,
              user: peerConnection.localDescription,
            });
          })
          .catch((error) => {
            console.error("Failed to create session description:", error);
          });
      }

      function handleIceCandidate(event) {
        if (event.candidate) {
          socket.emit("candidate", {
            room,
            sender: peerConnection.localDescription,
            candidate,
          });
        }
      }

      function handleRemoteStream(event) {
        remoteVideo.srcObject = event.streams[0];
      }

      function hangup() {
        remoteStream.getTracks().forEach((track) => {
          track.stop();
        });
        localStream.getTracks().forEach((track) => {
          track.stop();
        });
        peerConnection.close();
        peerConnection = null;
        callButton.disabled = false;
        hangupButton.disabled = true;
      }
    </script>
  </body>
</html>
