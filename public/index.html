<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Video Chat</title>
    <style>
      video {
        max-width: 400px;
        max-height: 300px;
      }
    </style>
  </head>
  <body>
    <h1>Video Chat</h1>
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      const localVideo = document.getElementById("localVideo");
      const remoteVideo = document.getElementById("remoteVideo");

      // Set up a local media stream
      navigator.mediaDevices
        .getUserMedia({ video: true, audio: true })
        .then((stream) => {
          localVideo.srcObject = stream;

          // Set up a RTCPeerConnection
          const pc = new RTCPeerConnection();
          pc.onicecandidate = handleIceCandidate;
          pc.ontrack = handleTrackEvent;

          // Add local stream to the peer connection
          stream.getTracks().forEach((track) => pc.addTrack(track, stream));

          // Signaling logic
          pc.onnegotiationneeded = () => {
            if (pc.signalingState !== "stable") return;
            pc.createOffer()
              .then((offer) => pc.setLocalDescription(offer))
              .then(() => {
                socket.emit("offer", {
                  room: "1",
                  target: "otherUser",
                  sdp: pc.localDescription,
                });
              });
          };

          // Connection handling
          socket.on("offer", (data) => {
            if (data.room === "1" && data.sender !== socket.id) {
              pc.setRemoteDescription(data.sdp)
                .then(() => pc.createAnswer())
                .then((answer) => pc.setLocalDescription(answer))
                .then(() => {
                  socket.emit("answer", {
                    room: "1",
                    target: data.sender,
                    sdp: pc.localDescription,
                  });
                });
            }
          });

          socket.on("answer", (data) => {
            if (data.room === "1" && data.sender !== socket.id) {
              pc.setRemoteDescription(data.sdp);
            }
          });

          socket.on("candidate", (data) => {
            if (data.room === "1" && data.sender !== socket.id) {
              const candidate = new RTCIceCandidate(data.candidate);
              pc.addIceCandidate(candidate);
            }
          });
        });

      // Helper functions
      function handleIceCandidate(event) {
        if (event.candidate) {
          socket.emit("candidate", {
            room: "1",
            target: "otherUser",
            candidate: event.candidate,
          });
        }
      }

      function handleTrackEvent(event) {
        remoteVideo.srcObject = event.streams[0];
      }
    </script>
  </body>
</html>
